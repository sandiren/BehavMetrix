{% extends 'base.html' %}
{% block content %}
{% set pinned_list = pinned_ids | list %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
  <div>
    <h1 class="h3 mb-0">Colony Dashboard</h1>
    <p class="text-muted small">Real-time overview for {{ progress.total }} registered animals. {{ progress.observed }} observed today.</p>
  </div>
  <form class="row gy-2 gx-2 align-items-end" method="get">
    <input type="hidden" name="pinned" value="{{ pinned_list | join(',') }}" />
    <div class="col-sm-4">
      <label class="form-label text-muted small">Search ID / Name / Matriline</label>
      <input type="search" class="form-control" name="search" placeholder="e.g. BM-021 or Alpha" value="{{ search_term }}" />
    </div>
    <div class="col-sm-3">
      <label class="form-label text-muted small">Cage</label>
      <select class="form-select" name="cage">
        <option value="">All cages</option>
        {% for cage in cage_choices %}
        <option value="{{ cage }}" {% if cage == cage_filter %}selected{% endif %}>{{ cage }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-3">
      <label class="form-label text-muted small">Sex</label>
      <select class="form-select" name="sex">
        <option value="">All</option>
        {% for sex_option in sex_choices %}
        <option value="{{ sex_option }}" {% if sex_option == sex_filter %}selected{% endif %}>{{ sex_option }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-2 d-grid">
      <button type="submit" class="btn btn-primary">Filter</button>
    </div>
  </form>
  <div class="d-flex gap-2">
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('routes.export_resource', resource='animals', ext='csv') }}">Export CSV</a>
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('routes.export_resource', resource='animals', ext='json') }}">Export JSON</a>
  </div>
</div>
<div class="row g-3 mb-4">
  {% for key, value in stats.items() %}
  <div class="col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h2 class="h6 text-uppercase text-muted">{{ key }}</h2>
        <p class="display-6 mb-0">{{ value }}</p>
      </div>
    </div>
  </div>
  {% endfor %}
  <div class="col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h2 class="h6 text-uppercase text-muted">Progress</h2>
        <p class="display-6 mb-0">{{ progress.observed }} / {{ progress.total }}</p>
        <span class="text-muted small">Animals logged today</span>
      </div>
    </div>
  </div>
</div>
{% if pinned_profiles %}
<h2 class="h5">Pinned Animals</h2>
<div class="row g-3 mb-4">
  {% for profile in pinned_profiles %}
  {% include 'partials/animal_profile_card.html' %}
  {% endfor %}
</div>
{% endif %}
<h2 class="h5">Colony Overview</h2>
<div class="row g-3">
  {% for profile in profiles %}
  {% include 'partials/animal_profile_card.html' %}
  {% endfor %}
</div>
<div class="row align-items-center mt-5">
  <div class="col-lg-8">
    <h2 class="h4">Social Rank Network</h2>
    <div class="alert alert-warning" role="alert" {% if not instability_flags %}hidden{% endif %}>
      Instability detected for animals: {{ instability_flags | list | join(', ') }}
    </div>
    <div id="rank-network" class="my-4 border rounded bg-body" style="min-height: 420px"></div>
  </div>
  <div class="col-lg-4">
    <h3 class="h6 text-muted">Recent Sessions</h3>
    <ul class="list-group mb-3">
      {% for session in recent_sessions %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>
          <strong>{{ session.name or 'Untitled' }}</strong>
          <span class="badge text-bg-light">{{ session.mode|replace('_', ' ') }}</span>
          <div class="small text-muted">{{ session.started_at.strftime('%b %d, %H:%M') }}{% if session.ended_at %} → {{ session.ended_at.strftime('%H:%M') }}{% endif %}</div>
        </span>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('routes.behavior_log', session_id=session.id) }}">Open</a>
      </li>
      {% else %}
      <li class="list-group-item small text-muted">No sessions yet.</li>
      {% endfor %}
    </ul>
    <div class="card">
      <div class="card-body">
        <h3 class="h6 text-muted">Alerts</h3>
        {% if elo_alerts %}
        <ul class="list-unstyled mb-0">
          {% for animal_id, alert in elo_alerts.items() %}
          {% set subject = animal_lookup.get(animal_id) %}
          <li>
            <span class="badge bg-danger">Rank</span>
            {{ alert }} —
            {% if subject %}
              {{ subject.name or subject.persistent_id }}
            {% else %}
              Animal {{ animal_id }}
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="small text-muted mb-0">No rank alerts.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
  const networkData = {{ network_data | safe }};
  const networkEl = document.getElementById('rank-network');
  const width = networkEl.clientWidth || 800;
  const height = 420;
  const svg = d3
    .select('#rank-network')
    .append('svg')
    .attr('viewBox', `0 0 ${width} ${height}`)
    .classed('w-100', true)
    .classed('h-100', true);

  const link = svg
    .append('g')
    .attr('stroke', '#bbb')
    .selectAll('line')
    .data(networkData.edges)
    .join('line')
    .attr('stroke-width', (d) => Math.max(1, d.weight / 100));

  const node = svg
    .append('g')
    .attr('stroke', '#fff')
    .attr('stroke-width', 1.5)
    .selectAll('circle')
    .data(networkData.nodes)
    .join('circle')
    .attr('r', (d) => Math.max(8, d.elo / 220))
    .attr('fill', (d) => (d.alert ? '#dc3545' : '#0d6efd'))
    .call(d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended));

  const label = svg
    .append('g')
    .selectAll('text')
    .data(networkData.nodes)
    .join('text')
    .attr('dx', 12)
    .attr('dy', '.35em')
    .text((d) => `${d.label} (${Math.round(d.elo)})`);

  const simulation = d3
    .forceSimulation(networkData.nodes)
    .force('link', d3.forceLink(networkData.edges).id((d) => d.id).distance(120))
    .force('charge', d3.forceManyBody().strength(-250))
    .force('center', d3.forceCenter(width / 2, height / 2));

  simulation.on('tick', () => {
    link
      .attr('x1', (d) => d.source.x)
      .attr('y1', (d) => d.source.y)
      .attr('x2', (d) => d.target.x)
      .attr('y2', (d) => d.target.y);

    node.attr('cx', (d) => d.x).attr('cy', (d) => d.y);
    label.attr('x', (d) => d.x).attr('y', (d) => d.y);
  });

  function dragstarted(event) {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    event.subject.fx = event.subject.x;
    event.subject.fy = event.subject.y;
  }

  function dragged(event) {
    event.subject.fx = event.x;
    event.subject.fy = event.y;
  }

  function dragended(event) {
    if (!event.active) simulation.alphaTarget(0);
    event.subject.fx = null;
    event.subject.fy = null;
  }

  document.querySelectorAll('.profile-card').forEach((card) => {
    const animalId = card.dataset.animal;
    const stress = JSON.parse(card.dataset.stress || '[]');
    const heatmap = JSON.parse(card.dataset.heatmap || '{}');
    const stressContainer = card.querySelector('.stress-chart');
    if (stress.length && stressContainer) {
      Plotly.newPlot(
        stressContainer,
        [
          {
            x: stress.map((point) => point.date),
            y: stress.map((point) => point.score),
            mode: 'lines+markers',
            line: { color: '#0d6efd' },
            fill: 'tozeroy',
          },
        ],
        {
          margin: { t: 10, l: 30, r: 10, b: 30 },
          height: 160,
          yaxis: { title: 'Stress', rangemode: 'tozero' },
        },
        { displayModeBar: false }
      );
    }
    const heatmapContainer = card.querySelector('.heatmap');
    if (Object.keys(heatmap).length && heatmapContainer) {
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const categories = Object.keys(heatmap);
      const z = categories.map((category) => days.map((day) => heatmap[category][day] || 0));
      Plotly.newPlot(
        heatmapContainer,
        [
          {
            z,
            x: days,
            y: categories,
            type: 'heatmap',
            colorscale: 'Blues',
          },
        ],
        {
          height: 180,
          margin: { t: 10, l: 60, r: 10, b: 30 },
        },
        { displayModeBar: false }
      );
    }
  });
</script>
{% endblock %}
