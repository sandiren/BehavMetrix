{% extends 'base.html' %}
{% block content %}
<h1 class="h3 mb-4">Stress Monitor</h1>
<div class="row g-4">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header">Log Stress Indicators</div>
      <div class="card-body">
        <form method="post" class="row g-3">
          <div class="col-12">
            <label class="form-label">Animal</label>
            <select class="form-select" name="animal_id" required>
              {% for animal in animals %}
              <option value="{{ animal.id }}">{{ animal.persistent_id }} — {{ animal.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" name="date" value="{{ today }}" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Stress Index (0-6)</label>
            <input type="number" min="0" max="6" class="form-control" name="stress_score" />
          </div>
          <div class="col-12">
            <div class="d-flex flex-wrap gap-3">
              {% set indicators = [
                ('withdrawal', 'Withdrawal'),
                ('fear_grimace', 'Fear Grimace'),
                ('pacing', 'Pacing'),
                ('self_biting', 'Self-biting'),
                ('scratching', 'Scratching'),
                ('vocalization', 'Vocalization'),
              ] %}
              {% for key, label in indicators %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="{{ key }}" id="{{ key }}" />
                <label class="form-check-label" for="{{ key }}">{{ label }}</label>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Linked Cortisol (ng/mL)</label>
            <input type="number" step="0.01" class="form-control" name="cortisol" />
          </div>
          <div class="col-12">
            <label class="form-label">Notes</label>
            <textarea class="form-control" name="notes" rows="2"></textarea>
          </div>
          <div class="col-12">
            <button class="btn btn-primary">Save Stress Log</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm mb-4">
      <div class="card-header">Alerts</div>
      <div class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
        {% for alert in alerts %}
        <div class="list-group-item small text-danger">
          <strong>{{ alert.animal.name or alert.animal.persistent_id }}</strong> — Stress index {{ alert.stress_score }}
          <div class="text-muted">{{ alert.date.strftime('%b %d') }} · {{ alert.notes or 'No notes' }}</div>
        </div>
        {% else %}
        <div class="list-group-item small text-muted">No high stress events recorded.</div>
        {% endfor %}
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="card-header">Daily Stress Index</div>
      <div class="card-body">
        <div id="stress-summary" data-summary='{{ daily_summary | tojson }}'></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const summaryEl = document.getElementById('stress-summary');
  if (summaryEl) {
    const summary = JSON.parse(summaryEl.dataset.summary || '{}');
    const days = Object.keys(summary).sort();
    const values = days.map((day) => summary[day]);
    if (days.length) {
      Plotly.newPlot(
        summaryEl,
        [
          {
            x: days,
            y: values,
            mode: 'lines+markers',
            line: { color: '#dc3545' },
            fill: 'tozeroy',
          },
        ],
        {
          margin: { t: 10, l: 40, r: 10, b: 40 },
          height: 280,
          yaxis: { rangemode: 'tozero' },
        },
        { displayModeBar: false }
      );
    }
  }
</script>
{% endblock %}
